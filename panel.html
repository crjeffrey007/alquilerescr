<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Usuario - Alquileres CR</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <link rel="stylesheet" href="css/panel.css" />
</head>
<body>
  <h1>Panel del Usuario</h1>

  <div id="user-info"></div>
  <div id="estado-cuenta" class="alert"></div>

  <h3>Publicar nuevo anuncio</h3>
  <form id="formAnuncio">
    <select id="categoria" required>
      <option value="">Seleccionar categorÃ­a</option>
      <option value="alquileres">Alquiler</option>
      <option value="ventas">Venta</option>
      <option value="negocios">Anuncio comercial</option>
    </select><br>
    <input type="text" id="titulo" placeholder="TÃ­tulo" required><br>
    <textarea id="descripcion" placeholder="DescripciÃ³n" required></textarea><br>
    <input type="text" id="ubicacion" placeholder="UbicaciÃ³n o direcciÃ³n" required><br>
    <input type="file" id="imagenDestacada" accept="image/*" required><br>
    <button type="submit">Publicar</button>
  </form>

  <h3>Mis publicaciones</h3>
  <ul id="listaPublicaciones"></ul>

  <button onclick="logoutUser()">Cerrar sesiÃ³n</button>

  <script src="js/auth.js"></script>
  <script>
    const db = firebase.firestore();
    const storage = firebase.storage();
    const userInfo = document.getElementById("user-info");
    const estadoCuenta = document.getElementById("estado-cuenta");
    const formAnuncio = document.getElementById("formAnuncio");
    const lista = document.getElementById("listaPublicaciones");

    let usuarioActual = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const doc = await db.collection("usuarios").doc(user.uid).get();
        usuarioActual = { uid: user.uid, ...doc.data() };

        const hoy = new Date();
        const expira = usuarioActual.fechaExpiracion ? new Date(usuarioActual.fechaExpiracion) : null;
        const expirada = expira && hoy > expira;

        userInfo.innerHTML = `<p>ðŸ‘‹ Hola ${usuarioActual.nombre}</p>
                              <p>Plan: ${usuarioActual.plan}</p>
                              <p>Publicaciones: ${usuarioActual.publicacionesActuales}/${usuarioActual.limitePublicaciones}</p>`;

        if (expirada) {
          estadoCuenta.innerHTML = "âš ï¸ Tu plan ha expirado. Contacta al administrador.";
          formAnuncio.style.display = "none";
        } else if (usuarioActual.publicacionesActuales >= usuarioActual.limitePublicaciones) {
          estadoCuenta.innerHTML = "ðŸ“¦ Has alcanzado el lÃ­mite de publicaciones.";
          formAnuncio.style.display = "none";
        } else {
          estadoCuenta.innerHTML = "âœ… Cuenta activa";
        }

        cargarPublicaciones(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    async function cargarPublicaciones(uid) {
      const snap = await db.collection("publicaciones").where("uid", "==", uid).get();
      lista.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        lista.innerHTML += `<li>${d.titulo} (${d.categoria})</li>`;
      });
    }

    formAnuncio.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!usuarioActual) return;

      // Sube la imagen destacada
      const file = document.getElementById("imagenDestacada").files[0];
      const ref = storage.ref(`imagenes/${usuarioActual.uid}/${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();

      // Guarda en Firestore
      await db.collection("publicaciones").add({
        uid: usuarioActual.uid,
        categoria: categoria.value,
        titulo: titulo.value,
        descripcion: descripcion.value,
        ubicacion: ubicacion.value,
        imagen: url,
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Actualiza conteo
      const nuevoConteo = (usuarioActual.publicacionesActuales || 0) + 1;
      await db.collection("usuarios").doc(usuarioActual.uid).update({
        publicacionesActuales: nuevoConteo
      });

      alert("âœ… PublicaciÃ³n creada correctamente");
      location.reload();
    });
  </script>
</body>
</html>
